Instruction for use of <Ne3dTomo> on tomographic reconstruction of 
 3D electron density of the corona using polarized brightness (pB) observations 
 from STEREO/COR1
 by Tongjiang Wang (email: wangt@cua.edu)
Revision history:
  March 28, 2025: First releaase
--------------------------------------------------------------------------------
 # Method
 The detailed method, applications to STEREO/COR1 data, validation, and uncertainty 
 analysis are discussed in the publication "Wang, T., Arge, C.N., & Jones, S. (2025), 
 "Improved Tomographic Reconstruction of 3D Global Coronal Density from STEREO/COR1 
 Observations", Solar Physics, 300, 46.  DOI: 10.1007/s11207-025-02454-8 
 Read the article in PDF at https://rdcu.be/egj5O

 # Required environment and Softwares
  Fortran 90 Compiler: ifx or gfortran in Linux OS
  The codes developed here (for spheric grid and cross validation) utilized m_mrgrnk.f90 
  in orderpack by Michel Olagnon (with CC0 1.0 Universal license; downloaded
  from http://www.fortran-2000.com/rank/)

 # Data preparation
   COR1 pB images are obtained from sets of three COR1 images taken at the polarizer angles
  (0,120,240) in sequence (see detailed descriptions in https://cor1.gsfc.nasa.gov/guide/).
   The IDL routines for data processing including despikes, rebinning, calculating the pB(r)
   background, the satellite position, and converting data from IDL format into the Fortran 
   readable format will become available soon.

 # Usage:
   1. Explanations for sub-directories created after unzipping the downloaded file:
    data/: including 28 128x128 pB images "cr2098_rbimg_sz128_[1-28].dat" to demonstrate the
           reconstruction of CR 2098. "cobs_coord_cr2098_dbl.txt" includes the locations of 
           observer (STEREO/COR1-B), obtained using get_stereo_lonlat() in SolarSoftware (SSW).
           "pbbk_xr_cr2098.txt" and "nrbk_xr_cr2098.txt": the background pB and density as a
           function of radial distance.
    Cart-grid/: code on Cartesian grid and run examples
    Sph-grid/ : code on spheric grid and run examples
    CV/       : codes for cross validations
    idl-pro/  : idl routies to show the results generated by Fortran codes

  2. Run example for Cartesian grid
    In Cart-grid/:
    * To ensure the code to run properly, you need to remove any restrictions on the stack size,
    In bash, use "ulimit -s unlimited". In C-shell, use "limit stacksize unlimited"

    Compilation using "ifx" in bash:
     ifx tomo_cart.f90 -O2 -heap-arrays -o run.x
    Compilation using "gfortran":
     gfortran tomo_cart.f90 -O2  -o run.x

    * Run the code:
     ./run.x < param_cart.txt
    Output: a file including the result [nsolu_sz128_reg2_nwt.dat] will be generated.

    * To show the result
      In idl-pro/
      idl> show_nmap_cart,2.5,/prf  ;or
      idl> show_nmap_cart,2.5,file='../Cart-grid/nsolu_sz128_reg2_nwt.dat',/prf
      show the spherical distribution of density at r=2.5 Rsun and radial profile of 
      the mean density.

    * Re-rsun the code:
      If you want to rerun the code using different value of regularization parameter,
    edit "param_cart.txt", set a new value for mu, and set  
      write_Abuff =0
      read_Abuff =1
      write_Rbuff =0
      read_Rbuff =1
      
     * Resume the code:
     If tol=0.01 is not small enough, for example, or the running is interrupted during iterration,
      edit "param_cart.txt", set resume=1 and other parameters as re-run.
     If a default solution file e.g., [nsolu_sz128_reg2_nwt.dat] already exists, a new file 
      [New_nsolu_sz128_reg2_nwt.dat] will be created.

   3. Run example for spheric grid
     In Sph-grid/
     * Compilation using "ifx":
      ifx m_mrgrnk.f90 -O2 -heap-arrays -c
      ifx tomo_sph.f90 m_mrgrnk.o -O2 -heap-arrays -o run.x
     * Compilation using "gfortran":
      gfortran m_mrgrnk.f90 -O2  -c
      gfortran tomo_sph.f90 m_mrgrnk.o -O2  -o run.x

     * Run the code:
     ./run.x < param_sph_reg2.txt % using 2nd-order smoothness in regularization
     ./run.x < param_sph_reg0.txt % using 2nd-order smoothness in regularization
     Note: Since the computation of matrix R in spheric grid is very fast, saving the result
        for R is not necessary: set write_Rbuff=0, read_Rbuff=0. However, if you want to apply
        the cross-validation to determine the optimal mu, you need to create a file for storing
         matrix R by setting write_Rbuff=1
     Output: the solution is saved in a file with the default name [nsolu_p181t91r51_reg2_nwt.dat]

    * To show the result
      In idl-pro/
      idl> show_nmap_sph,2.5  ;assuming both solutions for reg2 and reg0 are created.
      Compare the density maps at r=2.5 Rsun and radial profile of the mean density between the 
      solutions with 2nd-order and 0th-order smoothness

   4. Run example for CV
     In CV/
      * Compilation using "ifx":
     ifx m_mrgrnk.f90 -O2 -heap-arrays -c
     ifx tomo_cart_cv.f90 m_mrgrnk.o -O2 -heap-arrays -o run_cart.x  %for Cartesian-grid
     ifx tomo_sph_cv.f90 m_mrgrnk.o -O2 -heap-arrays -o run_sph.x    %for Spheric-grid
      
      * Run the code
      ./run_cart.x < param_cart_cv.txt %for Cartesian-grid
      ./run_sph.x < param_sph_cv.txt   %for Spheric-grid

      * To determine the optimal value for regularization parameter 
      In idl-pro/
      pfit_cv_fold5,file='../CV/cv_fold5sp0.20_sz128_nwt.txt' %for Cartesian-grid
      pfit_cv_fold5,file='../CV/cv_fold5sp0.20_p181t91r51_nwt.txt' %for Spheric-grid


   # Acknowledgement
    Important! Please cite the following paper to acknowledge the developer when  
    publishing the results, obtained from the original and modified codes. 
    Thank you very much. 


   # License
    All Copyrights (C) 2025 are reserved by Tongjiang Wang (wangt@cua.edu).

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version. Read the file LICENSE in detail. 

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details, 
    https://www.gnu.org/licenses/gpl-3.0.txt.

   
   # Report problems or bugs
     please contact Tongjiang Wang sending emails to wangt@cua.edu 
--------------------------------------------------------------------------------------------
